<%= render template: 't_facturas/preview' %>

<hr>
<% if @is_show %>
  <h3 align="center">RECIBO</h3>
<% else %>
  <h3 align="center">RECIBOS</h3>
<% end %>
<hr>

<%= render 't_recibos' if !@is_show && @t_recibos.any? %>

<% if !@is_show && @t_nota_creditos.any? %>
<h3 align="center">NOTAS DE CRÉDITO</h3>
<hr>
<%= render 't_nota_creditos/t_nota_creditos'%>
<% end %>


<div class="ibox">
  <div class="ibox-content">
    <%= form_for [:t_factura, @t_recibo] do |f| %>
      <div class="row">
        <div class="col-sm-6">

          <br>
          <div class="form-group row">
            <div class="col-sm-4 col-form-label">
              <%= f.label :pago_recibido, 'Monto Pagado', class: "text-right #{'opcional' if @is_show}" %>
            </div>
            <div class="col-sm-6 input-value">
              <% unless @is_show %>
                <%= f.text_field :pago_recibido, class: "form-control", id: 'payment-received-input', min: 0, step: 0.01 %>
              <% else %>
                <%= @t_recibo.pago_recibido %>
              <% end %>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="form-group row">
            <div class="col-sm-4 col-form-label">
              <%= f.label :pago_pendiente, 'Monto por Pagar', class: "text-right opcional" %>
            </div>
            <div class="col-sm-6 input-value">
              <% unless @is_show %>
                <%= f.text_field :pago_pendiente, class: "form-control", id: 'pending-payment-input', readonly: 'readonly', value: @pending_payment %>
              <% else %>
                <%= @t_recibo.pago_pendiente %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-6">
          <div class="form-group row">
            <div class="col-sm-4 col-form-label">
              <%= f.label :t_metodo_pago_id, 'Método de Pago', class: "text-right #{'opcional' if @is_show}" %>
            </div>
            <div class="col-sm-6 input-value">
              <% unless @is_show %>
                <%= f.select :t_metodo_pago_id, payment_method_options, {}, { class: "form-control", id: 'metodo-pago-select' } %>
              <% else %>
                <%= @t_recibo.t_metodo_pago.forma_pago %>
              <% end %>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="form-group row">
            <div class="col-sm-4 col-form-label">
              <%= f.label :justificacion, 'Justificación', class: "text-right opcional" %>
            </div>
            <div class="col-sm-6 input-value">
              <% unless @is_show %>
                <%= f.text_field :justificacion, class: "form-control" %>
              <% else %>
                <%= @t_recibo.justificacion %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-6" id="num-cheque-container">
          <div class="form-group row">
            <div class="col-sm-4 col-form-label">
              <%= f.label :num_cheque, 'Número de Cheque', class: "text-right #{'opcional' if @is_show}" %>
            </div>
            <div class="col-sm-6 input-value">
              <% unless @is_show %>
                <%= f.text_field :num_cheque, class: "form-control", id: 'num-cheque' %>
              <% else %>
                <%= @t_recibo.num_cheque %>
              <% end %>
            </div>
          </div>
        </div>
        <div align="center" class="col-sm-6">
          Servicios: <%= number_to_balboa(@t_recibo.get_services_total(@t_factura, @t_factura.t_recibos.empty?)) %><br>
          <span style="color: red;">
            Recargos: <%= number_to_balboa(@t_recibo.get_total_surcharge(@t_factura, @t_factura.t_recibos.empty?)) %>
          </span>
        </div>
      </div>

      <div class="row justify-content-sm-center">
        <div class="col-sm-2">
          <% if @is_show %>
            <%= render "shared/action_buttons",
              list_route: return_to, list_text: "Recibos",
              delete_route: t_factura_t_recibo_path(@t_factura, @t_recibo), delete_text: "Borrar",
              button_size: "xs"
            %>

            <%= link_to generar_pdf_t_factura_t_recibo_path(@t_factura, @t_recibo, format:'pdf'), target: "_blank", class: 'btn btn-primary' do %>
              <i class="fa fa-download"></i>
              Generar PDF
            <% end %>

          <% else %>
            <!-- <div class="text-center justify-content-md-center">
              <div class="btn-group" role="group">
                <%#= link_to t_factura_t_recibos_path(@t_factura), class: "btn btn-default btn-xs", title: 'Ver registros', 'data-toggle' => 'tooltip', 'data-placement' => 'right' do %>
                  <i class="glyphicon glyphicon-list-alt"></i> <%#= "Recibos" %>
                <%# end %>
                <a class="btn btn-primary btn-xs" href="#" onclick="">
                  <i class="glyphicon glyphicon-floppy-saved"></i> Guardar e Imprimir
                </a>
              </div>

              <%#= button_tag type: :submit, class: "btn btn-primary btn-xs", hidden: true, id: 'save', title: 'Guardar cambios', 'data-toggle' => 'tooltip', 'data-placement' => 'right' do %>
                <i class="glyphicon glyphicon-floppy-saved"></i> <%#= "Guardar e Imprimir" %>
              <%# end %>
            </div> -->
            <% if @last_t_recibo != nil %>
              <%= link_to generar_pdf_t_factura_t_recibo_path(@t_factura, @last_t_recibo, format:'pdf'), id: "generated_pdf", target: "_blank", class: 'btn btn-primary' do %>
                <i class="fa fa-download"></i>
                Generar PDF
              <% end %>
            <% end %>

            <script>
              ready = function() {
                document.getElementById('generated_pdf').style.display = "none"
                document.getElementById('generated_pdf').click();
              };

              $(document).ready(ready);
              $(document).on('page:load', ready);
            </script>

            <%= render "shared/action_buttons",
              list_route: t_factura_t_recibos_path(@t_factura), list_text: "Recibos",
              save_form: true,
              save_text: "Guardar e Imprimir" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    $('#payment-received-input').keyup(function() {
      allowOnlyNumbers(this);

      calculatePendingPayment(
        Number(<%= @pending_payment %>),
        Number($(this).val()),
        $('#pending-payment-input')
      );
    });

    showOrHideCheckNumber('#metodo-pago-select');
    $('#metodo-pago-select').change(function () {
      showOrHideCheckNumber(this);
    });

    // function preview_pdf() {
    //   window.location.href = "<%#= generar_pdf_t_factura_t_recibo_path(@t_factura, @t_recibo) %>";
    //   $('#save').click();
    // }
  });
</script>
