$(document).ready(function(){
  $('.select2').select2();
  $('.datepicker').datepicker({
    autoclose: true,
    format: "dd/mm/yyyy"
  });

  // Al asignar la cantidad, se actualiza la cantidad total, el subtotal y el total.
  $(document).on('keyup', '.quantity', function() {
    setTotal('#total-quantity', getTotal('.quantity'));
    setSubTotal(this);
    // cleanAllSurcharges();
    setTotal('#total', getTotal('.subtotal-cell') + Number($('#total-rate').text()));
    updateAllSurcharges();
  });

  // Al asignar el precio, se actualiza el subtotal y el total.
  $(document).on('keyup', '.price', function() {
    setSubTotal(this, false);
    // cleanAllSurcharges();
    setTotal('#total', getTotal('.subtotal-cell') + Number($('#total-rate').text()));
    updateAllSurcharges();
  });

  $("#select-codigo").select2({
    ajax: {
      url: '<%= "#{t_clientes_find_by_codigo_path}" %>',
      //url: '/t_clientes/find_by_codigo.json',
      dataType: 'json',
      data: function (params) {
        var query = {
          search: params.term
        }

        return query;
      },
      processResults: function (data) {
        return {
          results: $.map(data, function(t_cliente, i) {
            return { id: t_cliente.codigo, text: t_cliente.codigo } 
          })
        };
      },
      delay: 250
    },
    placeholder: 'Seleccione'
  });

  $("#select-resolucion").select2({
    ajax: {
      url: '<%= "#{t_clientes_find_by_resolucion_path}" %>',
      dataType: 'json',
      data: function (params) {
        var query = {
          search: params.term
        }

        return query;
      },
      processResults: function (data) {
        return {
          results: $.map(data, function(t_resolucion, i) {
            return { id: t_resolucion.id, text: t_resolucion.resolucion_codigo } 
          })
        };
      },
      delay: 250
    },
    placeholder: 'Seleccione',
    minimumInputLength: 1
  });

  $("#select-cedula").select2({
    ajax: {
      url: '<%= "#{t_clientes_find_by_cedula_path}" %>',
      dataType: 'json',
      data: function (params) {
        var query = {
          search: params.term
        }

        return query;
      },
      processResults: function (data) {
        return {
          results: $.map(data, function(persona, i) {
            return { id: persona.cedula ? persona.cedula : persona.rif, text: persona.cedula ? persona.cedula : persona.rif } 
          })
        };
      },
      delay: 250
    },
    placeholder: 'Seleccione'
  });

  $('.search-client').change(function() {
    $.ajax({
      url: '<%= "#{t_clientes_find_path}" %>',
      type: 'get',
      data: {
        attribute: $(this).attr('id'),
        search: $(this).val()
      }
    });
  });

  $(document).on('change', '.select-recargo', function(e) {
    // alert($(".select-recargo option:selected").data('value'));
    // var surcharge = Number($(this).find("option:selected").data('value'));
    // var selectRecargo = $(this);

    data = $(this).select2('data')[0];
    rate = Number(data.rate);
    // console.log(data.rate);

    // var surcharge = Number($(this).find("option:selected").val());
    $(this).find("option:selected").parent().parent().siblings().each(function () {
      if ($(this).hasClass('price-cell') || $(this).hasClass('surcharge-subtotal-cell')) {
        let priceInput = $(this).children().first();

        // cleanAllSurcharges();
        setTotal('#total', getTotal('.subtotal-cell'));
        priceInput.val(rate);
        updateAllSurcharges();
        setTotal('#total', getTotal('.subtotal-cell') + getTotal('.surcharge-subtotal-cell') + Number($('#total-rate').text()));
      }
    });
  });

  $(document).on('change', '.select-servicio', function(e) {
    var price = Number($(this).find("option:selected").data('value')),
        descripcion = $(this).find("option:selected").data('descripcion');
    $(this).find("option:selected").parent().parent().siblings().each(function () {
      if ($(this).hasClass('price-cell')) {
        // alert($(this).children().first().val());
        let priceInput = $(this).children().first();
        priceInput.val(price);
        priceInput.data('price', price);
        setSubTotal(priceInput, false);
        setTotal('#total', getTotal('.subtotal-cell') + Number($('#total-rate').text()));
      }

      if ($(this).hasClass('descripcion-cell')) {
        let descripcionInput = $(this).children().first();
        descripcionInput.val(descripcion)
      }
    });

    // cleanAllSurcharges();
    setTotal('#total', getTotal('.subtotal-cell'));
    updateAllSurcharges();
    setTotal('#total', getTotal('.subtotal-cell') + Number($('#total-rate').text()));
  });

  $('form').submit(function(event) {
    event.preventDefault(); //this will prevent the default submit
    //alert($('#total').text());
    $('#input-total-factura').val(Number($('#total').text()));
    $(this).unbind('submit').submit(); // continue the submit unbind preventDefault
  });
});
